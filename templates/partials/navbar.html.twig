<nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container">
        <a class="navbar-brand" href="{{ path('app_home') }}">
            <i class="fas fa-city me-2"></i> CityFlow B√©nin
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarMain" aria-controls="navbarMain" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarMain">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                <li class="nav-item">
                    <a class="nav-link {{ app.request.get('_route') == 'app_home' ? 'active' : '' }}" href="{{ path('app_home') }}">
                        <i class="fas fa-home me-1"></i> Accueil
                    </a>
                </li>

                {# Liens pour tous les utilisateurs connect√©s (valid√©s OU mod√©rateurs/admins) #}
                {% if app.user and (app.user.estValide or is_granted('ROLE_MODERATOR')) %}
                    <li class="nav-item">
                        <a class="nav-link {{ app.request.get('_route') == 'app_carte' ? 'active' : '' }}" href="{{ path('app_carte') }}">
                            <i class="fas fa-map me-1"></i> Carte
                        </a>
                    </li>

                    {# Menu Signalements avec sous-menu #}
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle {{ app.request.get('_route') starts with 'app_signalement' ? 'active' : '' }}"
                           href="#" id="navbarDropdownSignalements" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-exclamation-triangle me-1"></i> Signalements
                        </a>
                        <ul class="dropdown-menu" aria-labelledby="navbarDropdownSignalements">
                            <li><a class="dropdown-item" href="{{ path('app_signalements') }}">
                                    <i class="fas fa-list me-2"></i> Consulter les signalements
                                </a></li>
                            {% if app.user.estValide %}
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="{{ path('app_signalement_nouveau') }}">
                                        <i class="fas fa-plus-circle me-2"></i> Signaler un probl√®me
                                    </a></li>
                                <li><a class="dropdown-item" href="{{ path('app_mes_signalements') }}">
                                        <i class="fas fa-user-check me-2"></i> Mes signalements
                                    </a></li>
                            {% endif %}
                        </ul>
                    </li>

                    {# Menu Messages (seulement pour utilisateurs valid√©s) #}
                    {% if app.user.estValide %}
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle position-relative {{ app.request.get('_route') starts with 'app_message' ? 'active' : '' }}"
                               href="#" id="navbarDropdownMessages" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-envelope me-1"></i> Messages
                                <span id="messagesBadge" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger d-none">
                                    <span id="messagesCount">0</span>
                                    <span class="visually-hidden">messages non lus</span>
                                </span>
                            </a>
                            <ul class="dropdown-menu" aria-labelledby="navbarDropdownMessages">
                                <li><a class="dropdown-item" href="{{ path('app_messages_inbox') }}">
                                        <i class="fas fa-inbox me-2"></i> Bo√Æte de r√©ception
                                    </a></li>
                                <li><a class="dropdown-item" href="{{ path('app_messages_sent') }}">
                                        <i class="fas fa-paper-plane me-2"></i> Messages envoy√©s
                                    </a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="{{ path('app_message_new') }}">
                                        <i class="fas fa-edit me-2"></i> Nouveau message
                                    </a></li>
                            </ul>
                        </li>
                    {% endif %}

                    {# Menu Gestion/Mod√©ration - AM√âLIOR√â avec les nouvelles routes #}
                    {% if is_granted('ROLE_MODERATOR') %}
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle {{ app.request.get('_route') starts with 'app_validation' or app.request.get('_route') starts with 'app_reparation' or app.request.get('_route') starts with 'app_admin' or app.request.get('_route') starts with 'app_moderateur' ? 'active' : '' }}"
                               href="#" id="navbarDropdownGestion" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                {% if is_granted('ROLE_ADMIN') %}
                                    <i class="fas fa-cogs me-1"></i> Gestion
                                {% else %}
                                    <i class="fas fa-gavel me-1"></i> Mod√©ration
                                {% endif %}
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdownGestion">
                                {# üéØ Dashboard Mod√©ration - NOUVELLES ROUTES #}
                                <li><h6 class="dropdown-header">
                                        <i class="fas fa-tachometer-alt me-2"></i>Dashboard Mod√©ration
                                    </h6></li>
                                <li><a class="dropdown-item" href="{{ path('app_moderateur_dashboard') }}">
                                        <i class="fas fa-chart-line me-2"></i> Vue d'ensemble
                                    </a></li>
                                <li><a class="dropdown-item" href="{{ path('app_moderateur_statistiques') }}">
                                        <i class="fas fa-chart-bar me-2"></i> Mes statistiques
                                    </a></li>

                                {# Section Validation - NOUVELLES ROUTES #}
                                <li><hr class="dropdown-divider"></li>
                                <li><h6 class="dropdown-header">
                                        <i class="fas fa-check-circle me-2"></i>Validation
                                    </h6></li>
                                <li><a class="dropdown-item" href="{{ path('app_moderateur_validation') }}">
                                        <i class="fas fa-clock me-2"></i> Signalements en attente
                                    </a></li>
                                <li><a class="dropdown-item" href="{{ path('app_moderateur_signalements') }}">
                                        <i class="fas fa-list-check me-2"></i> Tous les signalements
                                    </a></li>
                                <li><a class="dropdown-item" href="{{ path('app_moderateur_journal') }}">
                                        <i class="fas fa-history me-2"></i> Mon journal d'activit√©
                                    </a></li>

                                {# Section R√©parations (routes existantes) #}
                                <li><hr class="dropdown-divider"></li>
                                <li><h6 class="dropdown-header">
                                        <i class="fas fa-tools me-2"></i>R√©parations
                                    </h6></li>
                                <li><a class="dropdown-item" href="{{ path('app_reparations') }}">
                                        <i class="fas fa-wrench me-2"></i> Gestion des r√©parations
                                    </a></li>

                                {# Section Administration (seulement pour les admins) #}
                                {% if is_granted('ROLE_ADMIN') %}
                                    <li><hr class="dropdown-divider"></li>
                                    <li><h6 class="dropdown-header">
                                            <i class="fas fa-shield-alt me-2"></i>Administration
                                        </h6></li>
                                    <li><a class="dropdown-item" href="{{ path('app_admin_dashboard') }}">
                                            <i class="fas fa-tachometer-alt me-2"></i> Dashboard Admin
                                        </a></li>
                                    <li><a class="dropdown-item" href="{{ path('app_admin_users') }}">
                                            <i class="fas fa-users me-2"></i> Utilisateurs
                                        </a></li>
                                    <li><a class="dropdown-item" href="{{ path('app_admin_signalements') }}">
                                            <i class="fas fa-database me-2"></i> Base de donn√©es signalements
                                        </a></li>
                                    <li><a class="dropdown-item" href="{{ path('app_admin_demandes_suppression') }}">
                                            <i class="fas fa-trash-alt me-2"></i> Demandes de suppression
                                        </a></li>
                                    <li><a class="dropdown-item" href="{{ path('app_admin_statistiques') }}">
                                            <i class="fas fa-chart-pie me-2"></i> Statistiques globales
                                        </a></li>

                                    {# Section d√©veloppement (visible uniquement en mode dev) #}
                                    {% if app.environment == 'dev' %}
                                        <li><hr class="dropdown-divider"></li>
                                        <li><h6 class="dropdown-header">
                                                <i class="fas fa-code me-2"></i>D√©veloppement
                                            </h6></li>
                                        <li><a class="dropdown-item" href="#">
                                                <i class="fas fa-bug me-2"></i> Test notifications
                                            </a></li>
                                    {% endif %}
                                {% endif %}
                            </ul>
                        </li>
                    {% endif %}
                {% endif %}
            </ul>

            {# Partie droite de la navbar - Utilisateur connect√© ou connexion #}
            <ul class="navbar-nav">
                {% if app.user %}
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdownUser" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-user-circle me-1"></i>
                            {{ app.user.prenom }} {{ app.user.nom }}
                            {% if not app.user.estValide and not is_granted('ROLE_MODERATOR') %}
                                <span class="badge bg-warning ms-1">En attente</span>
                            {% endif %}
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdownUser">
                            <li><a class="dropdown-item" href="{{ path('app_profil_show') }}">
                                    <i class="fas fa-user me-2"></i> Mon profil
                                </a></li>
                            <li><a class="dropdown-item" href="{{ path('app_profil_edit') }}">
                                    <i class="fas fa-edit me-2"></i> Modifier profil
                                </a></li>

                            {# Liens sp√©cifiques aux mod√©rateurs/admins #}
                            {% if is_granted('ROLE_MODERATOR') %}
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="{{ path('app_moderateur_dashboard') }}">
                                        <i class="fas fa-tachometer-alt me-2"></i> Dashboard Mod√©ration
                                    </a></li>
                            {% endif %}

                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="{{ path('app_logout') }}">
                                    <i class="fas fa-sign-out-alt me-2"></i> D√©connexion
                                </a></li>
                        </ul>
                    </li>
                {% else %}
                    <li class="nav-item">
                        <a class="nav-link" href="{{ path('app_login') }}">
                            <i class="fas fa-sign-in-alt me-1"></i> Connexion
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ path('app_register') }}">
                            <i class="fas fa-user-plus me-1"></i> Inscription
                        </a>
                    </li>
                {% endif %}
            </ul>
        </div>
    </div>
</nav>

{# Script pour les notifications en temps r√©el (si impl√©ment√©) #}
{% if app.user and app.user.estValide %}
    <script>
        // Fonction pour v√©rifier les nouveaux messages
        function checkNewMessages() {
            // Cette fonction peut √™tre impl√©ment√©e pour v√©rifier les nouveaux messages via AJAX
            // et mettre √† jour le badge de notification
        }

        // V√©rifier les nouveaux messages toutes les 30 secondes
        document.addEventListener('DOMContentLoaded', function() {
            setInterval(checkNewMessages, 30000);
        });
    </script>
{% endif %}