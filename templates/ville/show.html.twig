{% extends 'admin/layout.html.twig' %}

{% block title %}{{ signalement.titre }} - Administration{% endblock %}

{% block admin_breadcrumb %}
    <li class="breadcrumb-item">
        <a href="{{ path('app_admin_signalements') }}">Signalements</a>
    </li>
    <li class="breadcrumb-item active">Signalement #{{ signalement.id }}</li>
{% endblock %}

{% block admin_content %}
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="mb-1">
                <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                Signalement #{{ signalement.id }}
            </h1>
            <p class="text-muted mb-0">Vue administrative complète</p>
        </div>
        <div class="btn-group">
            <a href="{{ path('app_admin_signalements') }}" class="btn btn-outline-primary">
                <i class="fas fa-arrow-left me-1"></i> Retour à la liste
            </a>
            {% if signalement.etatValidation == 'valide' %}
                <a href="{{ path('app_signalement_show', {'id': signalement.id}) }}"
                   class="btn btn-info" target="_blank">
                    <i class="fas fa-external-link-alt me-1"></i> Vue publique
                </a>
            {% endif %}
            <a href="{{ path('app_moderateur_signalements_show', {'id': signalement.id}) }}"
               class="btn btn-outline-info">
                <i class="fas fa-gavel me-1"></i> Mode modération
            </a>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <!-- Informations principales -->
            <div class="card admin-card mb-4">
                <div class="card-header admin-card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        Informations du signalement
                    </h5>
                </div>
                <div class="card-body">
                    <h3 class="text-primary mb-3">{{ signalement.titre }}</h3>

                    {% if signalement.description %}
                        <div class="alert alert-light">
                            <h6><i class="fas fa-align-left me-2"></i>Description :</h6>
                            <p class="mb-0">{{ signalement.description }}</p>
                        </div>
                    {% endif %}

                    <div class="row">
                        <div class="col-md-6">
                            <table class="table table-borderless">
                                <tr>
                                    <td class="fw-bold">ID :</td>
                                    <td><span class="badge bg-primary">#{{ signalement.id }}</span></td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">Adresse :</td>
                                    <td>{{ signalement.adresse }}</td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">Ville :</td>
                                    <td>
                                        {% if signalement.ville %}
                                            <span class="badge bg-primary">
                                            <i class="fas fa-map-marker-alt me-1"></i>
                                            {{ signalement.ville.nom }}
                                        </span>
                                        {% else %}
                                            <span class="text-muted">Non définie</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">Catégorie :</td>
                                    <td>
                                        {% if signalement.categorie %}
                                            <span class="badge" style="background-color: {{ signalement.categorie.couleur }}">
                                            {{ signalement.categorie.nom }}
                                        </span>
                                        {% else %}
                                            <span class="text-muted">Non catégorisé</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">Priorité :</td>
                                    <td>
                                        {% if signalement.priorite %}
                                            <span class="badge bg-warning">Haute</span>
                                        {% else %}
                                            <span class="badge bg-secondary">Normale</span>
                                        {% endif %}
                                    </td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <table class="table table-borderless">
                                <tr>
                                    <td class="fw-bold">Date de création :</td>
                                    <td>{{ signalement.dateSignalement|date('d/m/Y à H:i') }}</td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">Signalé par :</td>
                                    <td>
                                        {% if signalement.utilisateur %}
                                            <div>
                                                <strong>{{ signalement.utilisateur.prenom }} {{ signalement.utilisateur.nom }}</strong>
                                                {% if is_granted('ROLE_ADMIN') %}
                                                    <br><small class="text-muted">{{ signalement.utilisateur.email }}</small>
                                                    {% if signalement.utilisateur.telephone %}
                                                        <br><small class="text-muted">{{ signalement.utilisateur.telephone }}</small>
                                                    {% endif %}
                                                {% endif %}
                                            </div>
                                        {% else %}
                                            <span class="text-danger">
                                            <i class="fas fa-user-slash me-1"></i>Utilisateur supprimé
                                        </span>
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">Coordonnées GPS :</td>
                                    <td>
                                        {% if signalement.latitude and signalement.longitude %}
                                            <small>
                                                Lat: {{ signalement.latitude }}<br>
                                                Lng: {{ signalement.longitude }}
                                            </small>
                                            <br>
                                            <a href="https://www.google.com/maps?q={{ signalement.latitude }},{{ signalement.longitude }}"
                                               target="_blank" class="btn btn-sm btn-outline-primary mt-1">
                                                <i class="fas fa-external-link-alt me-1"></i>Google Maps
                                            </a>
                                        {% else %}
                                            <span class="text-muted">Non disponibles</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">Dernière modif :</td>
                                    <td>
                                        {% if signalement.dateModification %}
                                            {{ signalement.dateModification|date('d/m/Y à H:i') }}
                                        {% else %}
                                            <span class="text-muted">Jamais modifié</span>
                                        {% endif %}
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Photos du signalement -->
            {% if signalement.photos|length > 0 %}
                <div class="card admin-card mb-4">
                    <div class="card-header admin-card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-images me-2"></i>
                            Photos ({{ signalement.photos|length }})
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            {% for photo in signalement.photos %}
                                <div class="col-md-4 mb-3">
                                    <div class="card">
                                        <img src="{{ asset('uploads/signalements/' ~ photo.nomFichier) }}"
                                             alt="Photo du signalement"
                                             class="card-img-top"
                                             data-bs-toggle="modal"
                                             data-bs-target="#photoModal{{ loop.index }}"
                                             style="cursor: pointer; height: 200px; object-fit: cover;">
                                        <div class="card-body p-2">
                                            <small class="text-muted">
                                                <i class="fas fa-file me-1"></i>{{ photo.nomFichier }}
                                            </small>
                                        </div>
                                    </div>
                                </div>

                                <!-- Modal pour agrandir la photo -->
                                <div class="modal fade" id="photoModal{{ loop.index }}" tabindex="-1">
                                    <div class="modal-dialog modal-lg">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title">Photo {{ loop.index }} - {{ photo.nomFichier }}</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                            </div>
                                            <div class="modal-body text-center">
                                                <img src="{{ asset('uploads/signalements/' ~ photo.nomFichier) }}"
                                                     alt="Photo du signalement"
                                                     class="img-fluid">
                                            </div>
                                            <div class="modal-footer">
                                                <a href="{{ asset('uploads/signalements/' ~ photo.nomFichier) }}"
                                                   download class="btn btn-primary">
                                                    <i class="fas fa-download me-1"></i>Télécharger
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            {% endif %}

            <!-- Commentaires -->
            {% if signalement.commentaires|length > 0 %}
                <div class="card admin-card mb-4">
                    <div class="card-header admin-card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-comments me-2"></i>
                            Commentaires ({{ signalement.commentaires|length }})
                        </h5>
                    </div>
                    <div class="card-body">
                        {% for commentaire in signalement.commentaires %}
                            <div class="border-bottom pb-3 mb-3 {% if loop.last %}border-0 pb-0 mb-0{% endif %}">
                                <div class="d-flex align-items-start">
                                    <div class="flex-shrink-0">
                                        <div class="bg-primary bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                            <i class="fas fa-user text-primary"></i>
                                        </div>
                                    </div>
                                    <div class="flex-grow-1 ms-3">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div>
                                                <h6 class="mb-0">
                                                    {% if commentaire.utilisateur %}
                                                        {{ commentaire.utilisateur.prenom }} {{ commentaire.utilisateur.nom }}
                                                    {% else %}
                                                        <span class="text-muted">Utilisateur supprimé</span>
                                                    {% endif %}
                                                </h6>
                                                <small class="text-muted">{{ commentaire.dateCommentaire|date('d/m/Y à H:i') }}</small>
                                            </div>
                                        </div>
                                        <p class="mt-2 mb-0">{{ commentaire.contenu }}</p>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}

            <!-- Journal de validation -->
            {% if signalement.journalValidations|length > 0 %}
                <div class="card admin-card">
                    <div class="card-header admin-card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-history me-2"></i>
                            Historique de modération ({{ signalement.journalValidations|length }})
                        </h5>
                    </div>
                    <div class="card-body">
                        {% for journal in signalement.journalValidations %}
                            <div class="d-flex border-bottom pb-3 mb-3 {% if loop.last %}border-0 pb-0 mb-0{% endif %}">
                                <div class="me-3">
                                    {% if journal.action == 'valide' %}
                                        <i class="fas fa-check-circle text-success fa-2x"></i>
                                    {% elseif journal.action == 'rejete' %}
                                        <i class="fas fa-times-circle text-danger fa-2x"></i>
                                    {% else %}
                                        <i class="fas fa-circle text-secondary fa-2x"></i>
                                    {% endif %}
                                </div>
                                <div class="flex-grow-1">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <h6 class="mb-0">{{ journal.action|title }}</h6>
                                            <small class="text-muted">
                                                Par {{ journal.moderateur.prenom }} {{ journal.moderateur.nom }}
                                                le {{ journal.dateValidation|date('d/m/Y à H:i') }}
                                            </small>
                                        </div>
                                    </div>
                                    {% if journal.commentaire %}
                                        <div class="mt-2 p-2 bg-light rounded">
                                            {{ journal.commentaire }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}
        </div>

        <div class="col-lg-4">
            <!-- État et statut -->
            <div class="card admin-card mb-4">
                <div class="card-header admin-card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        État du signalement
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label"><strong>État de validation :</strong></label>
                        <div>
                            {% if signalement.etatValidation == 'en_attente' %}
                                <span class="badge bg-warning fs-6">En attente de validation</span>
                            {% elseif signalement.etatValidation == 'valide' %}
                                <span class="badge bg-success fs-6">Validé</span>
                            {% elseif signalement.etatValidation == 'rejete' %}
                                <span class="badge bg-danger fs-6">Rejeté</span>
                            {% endif %}
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label"><strong>Statut de traitement :</strong></label>
                        <div>
                            {% if signalement.statut %}
                                {% if signalement.statut.value == 'NOUVEAU' %}
                                    <span class="badge bg-primary fs-6">Nouveau</span>
                                {% elseif signalement.statut.value == 'EN_COURS' %}
                                    <span class="badge bg-warning fs-6">En cours</span>
                                {% elseif signalement.statut.value == 'RESOLU' %}
                                    <span class="badge bg-success fs-6">Résolu</span>
                                {% elseif signalement.statut.value == 'ANNULE' %}
                                    <span class="badge bg-secondary fs-6">Annulé</span>
                                {% endif %}
                            {% else %}
                                <span class="badge bg-secondary fs-6">Non défini</span>
                            {% endif %}
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label"><strong>Visibilité publique :</strong></label>
                        <div>
                            {% if signalement.etatValidation == 'valide' %}
                                <span class="badge bg-success fs-6">
                                <i class="fas fa-eye me-1"></i>Visible
                            </span>
                            {% else %}
                                <span class="badge bg-secondary fs-6">
                                <i class="fas fa-eye-slash me-1"></i>Masqué
                            </span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Réparation associée -->
            {% if signalement.reparation %}
                <div class="card admin-card mb-4">
                    <div class="card-header admin-card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-tools me-2"></i>
                            Réparation associée
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-2">
                            <strong>Statut :</strong>
                            <span class="badge {{ signalement.reparation.statut.badgeClass }}">
                            {{ signalement.reparation.statut.label }}
                        </span>
                        </div>

                        {% if signalement.reparation.dateDebut %}
                            <div class="mb-2">
                                <strong>Date de début :</strong>
                                {{ signalement.reparation.dateDebut|date('d/m/Y') }}
                            </div>
                        {% endif %}

                        {% if signalement.reparation.cout %}
                            <div class="mb-2">
                                <strong>Coût estimé :</strong>
                                {{ signalement.reparation.cout|number_format(0, ',', ' ') }} FCFA
                            </div>
                        {% endif %}

                        {% if signalement.reparation.utilisateur %}
                            <div class="mb-2">
                                <strong>Assigné à :</strong>
                                {{ signalement.reparation.utilisateur.prenom }} {{ signalement.reparation.utilisateur.nom }}
                            </div>
                        {% endif %}
                    </div>
                </div>
            {% endif %}

            <!-- Actions administrateur -->
            <div class="card admin-card mb-4">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-shield-alt me-2"></i>
                        Actions Administrateur
                    </h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Attention :</strong> Ces actions sont réservées aux administrateurs et seront enregistrées dans les logs.
                    </div>

                    <div class="d-grid gap-2">
                        <!-- Suppression définitive -->
                        <button type="button" class="btn btn-danger"
                                data-bs-toggle="modal"
                                data-bs-target="#deleteModal">
                            <i class="fas fa-trash me-1"></i>Supprimer définitivement
                        </button>

                        <!-- Actions de modération directe -->
                        {% if signalement.etatValidation == 'en_attente' %}
                            <a href="{{ path('app_moderateur_signalements_show', {'id': signalement.id}) }}"
                               class="btn btn-warning">
                                <i class="fas fa-gavel me-1"></i>Modérer ce signalement
                            </a>
                        {% endif %}

                        <!-- Voir l'activité utilisateur -->
                        {% if signalement.utilisateur %}
                            <a href="{{ path('app_admin_users') }}?search={{ signalement.utilisateur.email }}"
                               class="btn btn-info">
                                <i class="fas fa-user me-1"></i>Voir l'utilisateur
                            </a>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Métadonnées techniques -->
            <div class="card admin-card">
                <div class="card-header admin-card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-cog me-2"></i>
                        Métadonnées techniques
                    </h5>
                </div>
                <div class="card-body">
                    <table class="table table-sm table-borderless mb-0">
                        <tr>
                            <td><strong>ID Base :</strong></td>
                            <td>{{ signalement.id }}</td>
                        </tr>
                        <tr>
                            <td><strong>Créé le :</strong></td>
                            <td>{{ signalement.dateSignalement|date('d/m/Y H:i:s') }}</td>
                        </tr>
                        {% if signalement.dateModification %}
                            <tr>
                                <td><strong>Modifié le :</strong></td>
                                <td>{{ signalement.dateModification|date('d/m/Y H:i:s') }}</td>
                            </tr>
                        {% endif %}
                        <tr>
                            <td><strong>Photos :</strong></td>
                            <td>{{ signalement.photos|length }} fichier(s)</td>
                        </tr>
                        <tr>
                            <td><strong>Commentaires :</strong></td>
                            <td>{{ signalement.commentaires|length }} commentaire(s)</td>
                        </tr>
                        <tr>
                            <td><strong>Validations :</strong></td>
                            <td>{{ signalement.journalValidations|length }} action(s)</td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de suppression définitive -->
    <div class="modal fade" id="deleteModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-trash me-2"></i>Suppression définitive
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>ATTENTION - Action irréversible !</strong>
                        <p class="mb-0 mt-2">Cette action supprimera définitivement :</p>
                        <ul class="mb-0 mt-2">
                            <li>Le signalement et toutes ses données</li>
                            <li>Toutes les photos associées ({{ signalement.photos|length }} fichiers)</li>
                            <li>Tous les commentaires ({{ signalement.commentaires|length }} commentaires)</li>
                            <li>L'historique de modération ({{ signalement.journalValidations|length }} actions)</li>
                            {% if signalement.reparation %}
                                <li>La réparation associée</li>
                            {% endif %}
                        </ul>
                    </div>

                    <h6 class="mt-4">Signalement à supprimer :</h6>
                    <div class="card">
                        <div class="card-body">
                            <h6 class="card-title">{{ signalement.titre }}</h6>
                            <p class="card-text">{{ signalement.description|slice(0, 100) }}{% if signalement.description|length > 100 %}...{% endif %}</p>
                            <p class="card-text">
                                <small class="text-muted">
                                    <i class="fas fa-user me-1"></i>
                                    {% if signalement.utilisateur %}
                                        {{ signalement.utilisateur.prenom }} {{ signalement.utilisateur.nom }} ({{ signalement.utilisateur.email }})
                                    {% else %}
                                        Utilisateur supprimé
                                    {% endif %}
                                    <br>
                                    <i class="fas fa-calendar me-1"></i>
                                    {{ signalement.dateSignalement|date('d/m/Y H:i') }}
                                    <br>
                                    <i class="fas fa-map-marker-alt me-1"></i>
                                    {% if signalement.ville %}{{ signalement.ville.nom }}{% else %}Ville non définie{% endif %}
                                </small>
                            </p>
                        </div>
                    </div>

                    <div class="alert alert-info mt-3">
                        <i class="fas fa-info-circle me-2"></i>
                        Cette action sera enregistrée dans les logs d'audit système avec votre identifiant.
                    </div>

                    <div class="form-check mt-3">
                        <input class="form-check-input" type="checkbox" id="confirmDelete" required>
                        <label class="form-check-label" for="confirmDelete">
                            Je confirme vouloir supprimer définitivement ce signalement
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Annuler
                    </button>
                    <form method="post" action="{{ path('app_admin_signalements_delete_force', {'id': signalement.id}) }}" style="display: inline;">
                        <input type="hidden" name="_token" value="{{ csrf_token('delete_force' ~ signalement.id) }}">
                        <button type="submit" class="btn btn-danger" id="deleteButton" disabled>
                            <i class="fas fa-trash me-1"></i>SUPPRIMER DÉFINITIVEMENT
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Activer le bouton de suppression seulement si la checkbox est cochée
            const confirmCheckbox = document.getElementById('confirmDelete');
            const deleteButton = document.getElementById('deleteButton');

            if (confirmCheckbox && deleteButton) {
                confirmCheckbox.addEventListener('change', function() {
                    deleteButton.disabled = !this.checked;
                });
            }

            // Réinitialiser la checkbox quand le modal se ferme
            const deleteModal = document.getElementById('deleteModal');
            if (deleteModal) {
                deleteModal.addEventListener('hidden.bs.modal', function() {
                    if (confirmCheckbox) {
                        confirmCheckbox.checked = false;
                        deleteButton.disabled = true;
                    }
                });
            }
        });
    </script>
{% endblock %}